name: prereleaser

on:
  # schedule every wednesday 9:30 AM UTC (3pm IST)
  schedule:
    - cron: '30 9 * * 3'

  # allow manual triggering of the workflow by a maintainer
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of the release"
        type: choice
        required: true
        options:
          - 'patch'
          - 'minor'
          - 'major'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - id: token
        name: github-token-gen
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PRIMUS_APP_ID }}
          private-key: ${{ secrets.PRIMUS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: verify-user
        run: |
          team_name="releasers"
          repo_owner=${{ github.repository_owner }}
          gh_actor=${{ github.actor }}

          echo "event_name: ${event_name}"
          echo "gh_actor: ${gh_actor}"

          if [[ "${event_name}" == "schedule" ]]; then
            echo "event is triggered by the scheduled cron"
            exit 0
          fi

          gh_response=$(curl -L --silent -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/orgs/${repo_owner}/teams/${team_name}/memberships/${gh_actor}") \
              | jq -r 'select(.role != []).role // "not-member"'
          if [[ "${gh_response}" != "member" ]]; then
            echo "user ${gh_actor} is not part of the releasers team" >&2
            exit 1
          fi
  signoz:
    uses: signoz/primus.workflows/.github/workflows/releaser.yaml@main
    secrets: inherit
    needs: [verify]
    with:
      PRIMUS_REF: main
      PROJECT_NAME: signoz
      RELEASE_TYPE: ${{ inputs.release_type || 'minor' }}
