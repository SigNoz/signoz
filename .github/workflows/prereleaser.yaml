name: prereleaser

on:
  # schedule every wednesday 9:30 AM UTC (3pm IST)
  schedule:
    - cron: '30 9 * * 3'

  # allow manual triggering of the workflow by a maintainer
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of the release"
        type: choice
        required: true
        options:
          - 'patch'
          - 'minor'
          - 'major'

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - id: token
        name: github-token-gen
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PRIMUS_APP_ID }}
          private-key: ${{ secrets.PRIMUS_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
      - name: primus-checkout
        uses: actions/checkout@v4
        with:
          repository: signoz/primus
          ref: main
          path: .primus
          token: ${{ steps.token.outputs.token }}
      - name: info
        run: |
          $MAKE info
      - name: verify-releaser-team-membership
        run: |
          if [[ "${{ github.event.name }}" == "schedule" ]]; then
            echo "skipping, event is triggered from scheduled cron"
            exit 0
          fi
          $MAKE github-verify-team-membership \
            GITHUB_ARGS="-t ${{ steps.token.outputs.token }} \
              -n releaser \
              -u ${{ github.actor }}"
  signoz:
    uses: signoz/primus.workflows/.github/workflows/releaser.yaml@main
    secrets: inherit
    needs: [verify]
    with:
      PRIMUS_REF: main
      PROJECT_NAME: signoz
      RELEASE_TYPE: ${{ inputs.release_type || 'minor' }}
